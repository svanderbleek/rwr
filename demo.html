<html>
  <body>
    <h2>Term Rewriting</h2>
    <p>Syntax<p>
    <code id="exp">
      [[["f", ["x", "x"]], [["f"], ["g"]]],
       [["f", "f"], [["f"], ["g"]]],
       [["f", ["x", "x"]], [["x"], ["y"]]],
       [["f", ["x", "x"]], [["f", ["x", "x"]], ["x"]]]]
    </code>
    <button id="run">run</button>
    <code id="out"></code>
    <p>Algorithm</p>
    <code>
      if(jseq(expression, rule[0])) return rule[1]
      if(expression[1] && expression[1].map) return [rewrite([expression[0]], rule), expression[1].flatMap((e) => rewrite([e], rule))]
      if(expression.map && expression.length > 1) return expression.flatMap((e) => rewrite([e], rule))
      return expression
    </code>
    <p>
      The essense of the matching algorithm is<br>
      expresion == rule left => rule right<br>
      expression is [app, [args]] => [rewrite(app), [rewrite(args)]]<br>
      otherwise => rewrite expression
    </p>
  </body>

  <style>
   code { display: block; white-space: pre-wrap; }
   #out { display: block; width: 100%; font: monospace; }
  </style>

  <script>
    const jseq = (a, b) => JSON.stringify(a) == JSON.stringify(b)
    const rewrite = (expression, rule) => {
      if(jseq(expression, rule[0])) return rule[1]
      if(expression[1] && expression[1].map) return [rewrite([expression[0]], rule), expression[1].flatMap((e) => rewrite([e], rule))]
      if(expression.map && expression.length > 1) return expression.flatMap((e) => rewrite([e], rule))
      return expression
    }

   const out = document.getElementById("out")
   const exp = document.getElementById("exp")
   const run = document.getElementById("run")

   run.addEventListener("click", () => {
     const examples = eval(exp.innerHTML)
     out.innerHTML = JSON.stringify(examples.map(([e, r]) => [e, r, rewrite(e, r)]))
   })
  </script>
</html>
